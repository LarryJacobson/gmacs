---
title: "Appendix comparing aspects of gmacs configured to be similar to that of Zheng et al. 2014"
output: pdf_document
---
## Results culminating from the mid-January 2015 crab modeling workshop

The following summarizes the outcome of some rudimentary comparisons between the existing BBRKC model and an emulated version using the gmacs platform.
Since the BBRKC model from Zheng et al. (2014) treats recruits by sex along with sex-specific natural mortality and fishing mortality, results from the male components are compared with
results from a `gmacs` model implementation tuned to male-only data. 


```{r global_options, include=FALSE}
library(knitr)
opts_chunk$set(fig.width=12, fig.height=8, fig.path='Figs/', echo=FALSE, warning=FALSE, message=FALSE)
```

```{r, load_packages, include=FALSE}
# echo=FALSE}
library(gmr)
source("../../../Rsrc/R/plot-sizecomp.R")
library(reshape2)
library(devtools)
#library(ggplot2)
# Set theme for ggplot2 (works for themes classic, minimal, gray, bw):
set_ggtheme('bw')

# Set working directory to that containing Gmacs model results:
setwd("~/_mymods/seacode/gmacs/examples/bbrkc")

fsh_names <- c("Directed","Pot discard", "Trawl discard")
lf_names <- c("Directed pot fishery","Pot fishery discard", "Trawl fishery discard","BTS Newshell","BTS Oldshell","BSFRF")
# Read in Jie's file
j_mmb = read.table("jie_mmb.rep",header=T)
j_surv = read.table("jie_survb.rep",header=T)
j_len = read.table("jie_len_sched.rep",header=T)
j_ltr = read.table("jie_lentrans.rep",header=F)
gmrep <- read_admb('gmacs')
```


# Size specific schedules

## Mean weight-at-length
The values used in both models are nearly identical:

```{r mean_wt}
#Mean weight
plot(gmrep$mid_points,(gmrep$mean_wt),typ="b",ylab="Mean weight at length",xlab="Carapace width (mm)",ylim=c(0,4))
lines(j_len$Size,j_len$MaleWt,col="red")
legend(130,1.2,c("gmacs","bbrkc"),pch=c(1,-1),lty=c(1,1),col=c(1,"red"))
```

  
## Initial recruitment size distribution
Gmacs was configured to match the Zheng et al. (2014) model closely and this was achieved: 

```{r init_rec}
#Recruitment size distribution
plot(gmrep$mid_points,gmrep$rec_sdd,typ="b",xlab="size",ylab="density",main="Recruitment size distribution")
#lines(j_len$Size,j_len$Female_R_sd,col="red")
lines(j_len$Size,j_len$Male_R_sd,col="red")
legend(130,.3,c("gmacs","bbrkc"),pch=c(1,-1),lty=1,col=c(1,"red"))
```

## Molting increment width
Options to fit relationship based on data was developed but for the BBRKC system, a size-specific vector was used to determine molt increments as show below.

```{r growth_inc}
plot_growth_inc(gmrep)
```

## Molting probability
Fixed parameters in gmacs were easily set to represent that assumed from Zheng et al. (2014).

```{r molt_prob}
# To compute same size-transition for comparisons
m <- diag(20)
diag(m)<-j_len$MP_1987
m <- as.matrix(j_ltr) %*% m
diag(m) <- diag(m)+(1-j_len$MP_1987)
# Molting probabilities
par(mfrow=c(1,1),mai=c(1,1.3,.3,.3))
plot(gmrep$mid_points,gmrep$molt_probability,typ="b",xlab="size",ylab="probability",main="Molting probability ")
lines(gmrep$mid_points,j_len$MP_1987,typ="l",col="red")
legend(80,.3,c("gmacs","bbrkc"),pch=c(1,-1),lty=1,col=c(1,"red"))
```

## Transition processes

The first set of figures is the growth probabilities (for all crabs that molt)

```{r growth_trans}
# For growth transition
par(mfrow=c(5,4),mai=c(0.1,0.1,0.1,.01))
for(j in 1:5)
	for(i in 1:4)
	{
		ii = j + (i-1 ) * 5
		plot(gmrep$mid_points,gmrep$growth_transition[ii,],typ="b",xlab="size",ylab="probability",ylim=c(0,.4),xaxt="n",yaxt="n")
		if (ii==1) text(130,.35,"Growth transition",cex=1.5)
		text(80,.35,paste(gmrep$mid_points[ii],"mm") ,cex=1)
	  lines(gmrep$mid_points,j_ltr[ii,],typ="l",col="red")
	  #legend(130,.18,c("gmacs","bbrkc"),pch=c(1,-1),lty=1,col=c(1,"red"))
	}
```

The second set of figures is the combination of growth and molting and represents the size transition:

```{r size_trans}
# For size transition
par(mfrow=c(5,4),mai=c(0.1,0.1,0.1,.01))
for(j in 1:5)
	for(i in 1:4)
	{
		ii = j + (i-1 ) * 5
		plot(gmrep$mid_points,gmrep$size_transition[ii,],typ="b",xlab="size",ylab="probability",ylim=c(0,.4),xaxt="n",yaxt="n")
		if (ii==1) text(130,.35,"Size transition",cex=1)
		text(80,.35,paste(gmrep$mid_points[ii],"mm") ,cex=1)
		#plot(gmrep$mid_points,gmrep$size_transition[i,],typ="b",xlab="size",ylab="probability",main=paste("Growth transition bin",i),ylim=c(0,.4))
	  lines(gmrep$mid_points,m[ii,],typ="l",col="red")
	  #legend(130,.18,c("gmacs","bbrkc"),pch=c(1,-1),lty=1,col=c(1,"red"))
	}
```

## Numbers at length in 1975
The scale of these results differ significantly and may be related to the interaction with natural mortality estimates and how the initial population-at-lengths were established (the BBRKC model assumes all new-shell).

```{r init_N}
# INitial Numbers at length
par(mfrow=c(1,1),mai=c(1,1,.5,.5))
plot(gmrep$mid_points,gmrep$N_len[1,],typ="b",xlab="size",ylab="density",main="N at length in 1975")
Nbeg = (j_len$N1975_male_n)/1000
lines(j_len$Size,Nbeg,col="red")
legend(130,50000,c("gmacs","bbrkc"),pch=c(1,-1),lty=c(1,1),col=c(1,"red"))
```
 
# Time series results/comparisons
## Natural mortality
The figure below illustrates implementation of 4 step changes in M (freely estimated) in gmacs relative to the estimates from Zheng et al. 2014.


```{r M_t}
#M over time
par(mfrow=c(1,1))
plot(gmrep$mod_yrs,(gmrep$M[,3]),typ="b",ylab="Natural mortality",xlab="Year",ylim=c(0,1))
lines(j_mmb$yr,j_mmb$M,col="red")
legend(2000,.8,c("gmacs","bbrkc"),pch=c(1,-1),lty=c(1,1),col=c(1,"red"))
```
 
## Recruitment
Recruitment patterns are similar, but differences in natural mortality schedules will affect these matches. The figure below plots the values to have the same mean.

```{r recruits}
# Recruitment comparisons
r1=get_recruitment(gmrep)
plot(r1$year,exp(r1$log_rec),typ="b",ylab="Recruits",xlab="Year")
#abline(h=mean(exp(r1$log_rec)))
R_m = j_mmb$R[2:40]
R_m = mean(exp(r1$log_rec))*( R_m/mean(R_m))
#lines(j_mmb$yr-1,j_mmb$R*10000,col="red")
lines(j_mmb$yr[1:39],R_m,col="red")
legend(2000,500000,c("gmacs","bbrkc"),pch=c(1,-1),lty=c(1,1),col=c(1,"red"))
```

## Fit to survey abundance indices
The model fit to survey biomass (males) was better for the current model (at least visually) than for the current implementation of gmacs:


```{r survey_biomass}
#Survey biomass fits
plot(gmrep$mod_yrs,(gmrep$pre_cpue[1,]),typ="b",ylab="survey biomass ",xlab="Year",ylim=c(0,300000))
lines(j_surv$year,j_surv$pred,col="red")
points(j_surv$year,j_surv$obs,col="red",pch=19)
#points(gmrep$mod_yrs,(gmrep$obs_cpue[1,]))
legend(2000,2.5e5,c("gmacs","bbrkc"),pch=c(1,-1),lty=c(1,1),col=c(1,"red"))
```

 
## Estimated retained catch and discards, for whole period
This figure summarizes the observed (horizontal) and predicted (vertical) catches by gear type. Data for discard fisheries were read in with 100% mortality (as clarified in Table 1 of Zheng et al. 2014).

```{r fit_to_catch}
#Fit to catch and discards
par(mfrow=c(2,2))
for (i in 1:3) plot(gmrep$obs_catch[i,],(gmrep$pre_catch[i,]),main=fsh_names[i],typ="p",pch=19,ylab="predicted ",xlab="observed ")
```



# Other diagnostics

## Fit to size frequency data

The subsequent figures provide fits to the male BBRKC data based on gmacs.

```{r sizecomps, echo=FALSE}
plot_sizecomp(gmrep,which_plots=1,main=lf_names[1])
plot_sizecomp(gmrep,which_plots=2,main=lf_names[2])
plot_sizecomp(gmrep,which_plots=3,main=lf_names[3])
plot_sizecomp(gmrep,which_plots=4,main=lf_names[4])
plot_sizecomp(gmrep,which_plots=5,main=lf_names[5])
plot_sizecomp(gmrep,which_plots=6,main=lf_names[6])
```



# Summary
Comparisons of actual likelihood function values and year-specific fits using the robust-multinomial would be the next step after selectivity issues are resolved. Subsequent to that,
it would be worth exploring aspects of alternative model specifications (e.g., constant natural mortality over time, time-varying selectivity, etc) to evaluate sensitivities.



