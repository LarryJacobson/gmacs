---
title: "Appendix comparing aspects of gmacs configured to be similar to that of Zheng et al. (2014)"
output: pdf_document
bibliography: ../../../docs/references/Gmacs.bib
---

The following summarizes the outcome of some comparisons between the existing
Bristol Bay red king crab (BBRKC) stock assessment model [@zheng_bristol_2014]
and an emulated version using the gmacs platform.  Since the BBRKC model from
@zheng_bristol_2014 treats recruits by sex along with sex-specific natural
mortality and fishing mortality, results from the male components are compared
with results from a `gmacs` model implementation tuned to male-only data.


```{r global_options, include=FALSE}
library(knitr)
opts_chunk$set(fig.width=12, fig.height=8, fig.path='Figs/', echo=FALSE, warning=FALSE, message=FALSE)
```

```{r, load_packages, include=FALSE}
library(gmr)
.MODELDIR = c("../TwoSex/","../TwoSex/")
.THEME    = theme_bw(base_size = 12, base_family = "")
.FLEET = c("Directed pot fishery", "Pot fishery discard", "Trawl fishery discard", "BTS Newshell", "BTS Oldshell", "BSFRF")
.SEX   = c("Aggregate","Male","Female")
.SHELL    = c("Aggregate","New Shell","Old Shell")
.MATURITY = c("Aggregate","Immature","Mature")
.TYPE     = c("Retained & Discarded","Retained","Discarded")
.SEAS     = c("Annual")

# Set working directory to that containing Gmacs model results
#setwd("~/_mymods/seacode/gmacs/examples/bbrkc")
#setwd("../jieOutput/")

model <- c("gmacs", "bbrkc")
fsh_names <- c("Directed", "Pot discard", "Trawl discard")
lf_names <- c("Directed pot fishery", "Pot fishery discard", "Trawl fishery discard", "BTS Newshell", "BTS Oldshell", "BSFRF")

# Read in Jie's file
j_mmb = read.table("../jieOutput/jie_mmb.rep", header=T)
j_surv = read.table("../jieOutput/jie_survb.rep", header=T)
j_len = read.table("../jieOutput/jie_len_sched.rep", header=T)
j_ltr = read.table("../jieOutput/jie_lentrans.rep", header=F)

# Read in gmacs file
fn       <- paste0(.MODELDIR, "gmacs")
M        <- lapply(fn, read_admb)
names(M) <- c(basename(.MODELDIR)[1], "Zheng")

M[[2]]$mmb <- j_mmb$mmb
M[[2]]$M <- matrix(c(j_mmb$M, j_mmb$M), nrow = 80, ncol = 20)

```


# Size specific schedules

## Mean weight-at-length

The mean weight-at-length ($w_\ell$) of crabs is defined in grams and the
carapace length ($\ell$, CL) in mm. The mean weight-at-length used in both
models is nearly identical (Figure \ref{fig:mean_wt}). The only difference
between the two models is in the final length class (160mm) where the mean
weight is greater in Zheng's model than in gmacs.

The length-weight relationships used in Zheng's model for males and females were
$$W = 0.000408 L^{3.127956} \quad \text{immature females},$$
$$W = 0.003593 L^{2.666076} \quad \text{ovigerous females},$$
$$W = 0.0004031 L^{3.141334} \quad \text{males}.$$

```{r mean_wt, fig.cap = "Mean weight-at-length.\\label{fig:mean_wt}"}
#Mean weight
plot_length_weight(M)
#plot(gmrep$mid_points, (gmrep$mean_wt), type="b", ylab="Mean weight at length", xlab="Carapace width (mm)", ylim=c(0,4), las = 1)
#lines(j_len$Size, j_len$MaleWt, col="red")
#legend("topleft", model, bty = "n", pch=c(1,-1), lty=c(1,1), col=c(1,"red"))
```


## Initial recruitment size distribution

Gmacs was configured to match the @zheng_bristol_2014 model closely and this was
achieved (Figure \ref{fig:init_rec}).

```{r init_rec, fig.cap = "Distribution of length at recruitment.\\label{fig:init_rec}"}
#Recruitment size distribution
plot(gmrep$mid_points, gmrep$rec_sdd, type="b", xlab="size", ylab="density", main="Recruitment size distribution", las = 1)
lines(gmrep2$mid_points, gmrep2$rec_sdd, type="b", col = "gray")
#lines(j_len$Size,j_len$Female_R_sd,col="red")
lines(j_len$Size,j_len$Male_R_sd,col="red")
legend("topright", model, bty = "n", pch = c(1,-1), lty = 1, col = c(1,2))
```

## Molting increment width

Options to fit relationship based on data was developed but for the BBRKC
system, a size-specific vector was used to determine molt increments as show
below (Figure \ref{fig:growth_inc}).

```{r growth_inc, fig.cap = "Growth increment.\\label{fig:growth_inc}"}
plot_growth_inc(M)
```

## Molting probability

Fixed parameters in gmacs were easily set to represent that assumed from
@zheng_bristol_2014 (Figure \ref{fig:molt_prob}).

```{r molt_prob, fig.cap = "Molting probability.\\label{fig:molt_prob}"}
# To compute same size-transition for comparisons
m <- diag(20)
diag(m) <- j_len$MP_1987
m <- as.matrix(j_ltr) %*% m
diag(m) <- diag(m)+(1-j_len$MP_1987)
# Molting probabilities
par(mfrow=c(1,1), mai=c(1,1.3,.3,.3))
plot(gmrep$mid_points, gmrep$molt_probability, type = "b", xlab="Size", ylab="Probability", main="Molting probability", las = 1, ylim = c(0, 1))
lines(gmrep$mid_points,j_len$MP_1987,typ="l",col="red")
legend("topright", model, bty = "n", pch = c(1,-1), lty = 1, col = c(1,"red"))
```


## Transition processes

The first set of figures is the growth probabilities (for all crabs that molt)
(Figure~\ref{fig:growth_trans}).

```{r growth_trans, fig.cap = "Growth transitions.\\label{fig:growth_trans}"}
# For growth transition
par(mfrow=c(5,4),mai=c(0.1,0.1,0.1,.01))
for(j in 1:5)
	for(i in 1:4)
	{
		ii = j + (i-1 ) * 5
		plot(gmrep$mid_points, gmrep$growth_transition[ii,],typ="b",xlab="size",ylab="probability",ylim=c(0,.4),xaxt="n",yaxt="n")
		if (ii==1) text(130,.35,"Growth transition",cex=1.5)
		text(80,.35,paste(gmrep$mid_points[ii],"mm") ,cex=1)
	  lines(gmrep$mid_points, j_ltr[ii,],typ="l",col="red")
	  #legend(130,.18, model, pch=c(1,-1), lty=1, col=c(1,"red"))
	}
```

The second set of figures is the combination of growth and molting and
represents the size transition (Figure \ref{fig:size_trans}).

```{r size_trans, fig.cap = "Growth transitions.\\label{fig:size_trans}"}
# For size transition
par(mfrow=c(5,4),mai=c(0.1,0.1,0.1,.01))
for(j in 1:5)
	for(i in 1:4)
	{
		ii = j + (i-1 ) * 5
		plot(gmrep$mid_points,gmrep$size_transition[ii,],typ="b",xlab="size",ylab="probability",ylim=c(0,.4),xaxt="n",yaxt="n")
		if (ii==1) text(130,.35,"Size transition",cex=1)
		text(80,.35,paste(gmrep$mid_points[ii],"mm") ,cex=1)
		#plot(gmrep$mid_points,gmrep$size_transition[i,],typ="b",xlab="size",ylab="probability",main=paste("Growth transition bin",i),ylim=c(0,.4))
	  lines(gmrep$mid_points,m[ii,],typ="l",col="red")
	  #legend(130,.18,c("gmacs","bbrkc"),pch=c(1,-1),lty=1,col=c(1,"red"))
	}
```


## Numbers at length in 1975

The scale of these results differ significantly and may be related to the
interaction with natural mortality estimates and how the initial
population-at-lengths were established (the BBRKC model assumes all new-shell)
(Figure \ref{fig:init_N}).

```{r init_N, fig.cap = "Numbers at length in 1975.\\label{fig:init_N}"}
# Initial Numbers at length
par(mfrow=c(1,1),mai=c(1,1,.5,.5))
plot(gmrep$mid_points, gmrep$N_len[1,], type = "b", xlab="size",ylab="Density",main="N at length in 1975", las = 1)
Nbeg <- (j_len$N1975_male_n)/1000
lines(j_len$Size, Nbeg, col = "red")
legend(130,50000,c("gmacs","bbrkc"),pch=c(1,-1),lty=c(1,1),col=c(1,"red"))
```


# Time series results/comparisons

## Natural mortality

The figure below illustrates implementation of four step changes in $M_t$
(freely estimated) in gmacs relative to the estimates from Zheng et al. 2014
(Figure \ref{fig:M_t}).

```{r M_t, fig.cap = "Time-varying natural mortality.\\label{fig:M_t}"}
plot_natural_mortality(M)
#par(mfrow=c(1,1))
#plot(gmrep$mod_yrs, (gmrep$M[,3]), type = "b", ylab = "Natural mortality", xlab = "Year", ylim = c(0,1), las = 1)
#lines(gmrep2$mod_yrs, (gmrep2$M[1:40,3]), type = "b", col = 4)
#lines(j_mmb$yr, j_mmb$M, col="red")
#legend("topright", model, bty = "n", pch = c(1,-1), lty = c(1,1), col = c(1,"red"))
```


## Recruitment

Recruitment patterns are similar, but differences in natural mortality schedules
will affect these matches. The figure below plots the values to have the same
mean (Figure \ref{fig:recruits}).

```{r recruits, fig.cap = "Recruitment ($R_t$).\\label{fig:recruits}"}
# Recruitment comparisons
M <- list(gmrep)
names(M) <- ""
r1=.get_recruitment_df(M)
M <- list(gmrep2)
names(M) <- ""
r2=.get_recruitment_df(M)
plot(r1$year, exp(r1$log_rec), type = "b", ylab = "Recruits", xlab = "Year")
lines(r2$year, exp(r2$log_rec)/1000, type = "b", col = 4)
#abline(h=mean(exp(r1$log_rec)))
R_m = j_mmb$R[2:40]
R_m = mean(exp(r1$log_rec))*( R_m/mean(R_m))
#lines(j_mmb$yr-1, j_mmb$R*10000, col="red")
lines(j_mmb$yr[1:39], R_m, col = "red")
legend("topright", model, pch=c(1,-1), lty=c(1,1), col=c(1,"red"))
```


## Fit to survey abundance indices

The model fit to survey biomass (males) was better for the current model (at
least visually) than for the current implementation of gmacs (Figure
\ref{fig:survey_biomass}).

```{r survey_biomass, fig.cap = "Survey biomass.\\label{fig:survey_biomass}"}
#Survey biomass fits
#plot(gmrep$mod_yrs, as.numeric(gmrep$pre_cpue[1,]), type = "b", ylab = "survey biomass ", xlab = "Year", ylim = c(0,300000))
# I've cheated a little here and used the other set of years
plot(j_surv$year, as.numeric(gmrep$pre_cpue[1,])*1000, type = "b", ylab = "survey biomass ", xlab = "Year", ylim = c(0,300000))
lines(j_surv$year, j_surv$pred, col = "red")
points(j_surv$year,j_surv$obs,col="red",pch=19)
#points(gmrep$mod_yrs,(gmrep$obs_cpue[1,]))
legend(2000,2.5e5,c("gmacs","bbrkc"),pch=c(1,-1),lty=c(1,1),col=c(1,"red"))
```


## Estimated retained catch and discards, for whole period

This figure summarizes the observed (horizontal) and predicted (vertical)
catches by gear type. Data for discard fisheries were read in with 100%
mortality (as clarified in Table 1 of Zheng et al. 2014) (Figure
\ref{fig:fit_to_catch}).

```{r fit_to_catch, fig.cap = "Fit to catch.\\label{fig:fit_to_catch}"}
#Fit to catch and discards
par(mfrow=c(2,2))
for (i in 1:3) plot(gmrep$obs_catch[i,], (gmrep$pre_catch[i,]), main=fsh_names[i], typ="p",pch=19,ylab="predicted ",xlab="observed ")
```


# Other diagnostics

## Fit to size frequency data

The subsequent figures provide fits to the male BBRKC data based on gmacs
(Figure \ref{fig:sizecomps}).

```{r sizecomps, fig.cap = "Size comps.\\label{fig:sizecomps}", echo=FALSE}
plot_sizeComps(M, which_plots=1)
plot_sizeComps(M, which_plots=2)
plot_sizeComps(M, which_plots=3)
plot_sizeComps(M, which_plots=4)
plot_sizeComps(M, which_plots=5)
plot_sizeComps(M, which_plots=6)
```


# Summary

Comparisons of actual likelihood function values and year-specific fits using
the robust-multinomial would be the next step after selectivity issues are
resolved. Subsequent to that, it would be worth exploring aspects of alternative
model specifications (e.g., constant natural mortality over time, time-varying
selectivity, etc) to evaluate sensitivities.


# References
